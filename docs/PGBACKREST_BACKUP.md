# pgBackRest - PostgreSQL Backup & Recovery

## Overview

This deployment includes **pgBackRest**, an enterprise-grade backup and restore solution for PostgreSQL with Point-in-Time Recovery (PITR) capabilities.

## Features

✅ **Automated Daily Backups** - Full backups run automatically at 1 AM  
✅ **Point-in-Time Recovery** - Restore to any second in the past  
✅ **S3-Compatible Storage** - Backups stored in Backblaze B2, MinIO, or AWS S3  
✅ **AES-256 Encryption** - Backups encrypted at rest  
✅ **Incremental Backups** - Block-level incremental for efficiency  
✅ **Multi-Repository** - Local + Cloud for redundancy  
✅ **Compression & Bundling** - Optimized storage usage  

## Architecture

### Backup Repositories

pgBackRest uses a **multi-repository strategy** for maximum safety:

#### 1. **Local Repository** (Fast Recovery)
- **Path:** `/pg/backup`
- **Retention:** Last 2 full backups
- **Purpose:** Fast local recovery without network dependency
- **Use Case:** Quick restores, testing, development

#### 2. **S3 Repository** (Long-term Storage)
- **Storage:** Backblaze B2 (or MinIO/AWS S3)
- **Retention:** 14 days of full backups
- **Encryption:** AES-256-CBC
- **Purpose:** Off-site backup for disaster recovery
- **Use Case:** Long-term retention, geographic redundancy

## Configuration

### Environment Variables

Configure pgBackRest in `.env`:

```bash
# Enable pgBackRest
PGBACKREST_ENABLED=true

# Backup method: local, minio, s3
PGBACKREST_METHOD=s3

# S3 Repository Configuration (Backblaze B2)
PGBACKREST_S3_BUCKET=bits-supabase-storage
PGBACKREST_S3_ENDPOINT=https://s3.us-east-005.backblazeb2.com
PGBACKREST_S3_REGION=us-east-005
PGBACKREST_S3_ACCESS_KEY=0054f413fc50d980000000005
PGBACKREST_S3_SECRET_KEY=K005QH3QznmevY7wUCOU7r5NFmv9Q2U

# Encryption (HIGHLY RECOMMENDED)
PGBACKREST_CIPHER_PASS=<auto-generated-or-custom>

# Backup Retention (days for full backups)
PGBACKREST_RETENTION_FULL=14

# Local Backup Repository
PGBACKREST_LOCAL_ENABLED=true
PGBACKREST_LOCAL_RETENTION_FULL=2
```

### Using the Same Bucket as Supabase Storage

You can use the same S3 bucket for both Supabase Storage and PostgreSQL backups:

```bash
# Leave pgBackRest S3 config empty to use Supabase S3 settings
PGBACKREST_S3_BUCKET=
PGBACKREST_S3_ENDPOINT=
PGBACKREST_S3_REGION=
PGBACKREST_S3_ACCESS_KEY=
PGBACKREST_S3_SECRET_KEY=
```

pgBackRest will automatically use the `S3_*` variables from Supabase Storage configuration.

### Using a Dedicated Backup Bucket

For better organization and security, create a dedicated bucket:

1. **Create a new bucket** in Backblaze B2: `bits-postgres-backups`
2. **Create a new Application Key** with:
   - Access to: `bits-postgres-backups`
   - Type: Read and Write
   - ✅ Allow List All Bucket Names
3. **Update .env:**

```bash
PGBACKREST_S3_BUCKET=bits-postgres-backups
PGBACKREST_S3_ENDPOINT=https://s3.us-east-005.backblazeb2.com
PGBACKREST_S3_REGION=us-east-005
PGBACKREST_S3_ACCESS_KEY=<new_key_id>
PGBACKREST_S3_SECRET_KEY=<new_application_key>
```

## Backup Schedule

### Automated Backups

Backups run automatically via cron:

```cron
00 01 * * * postgres /pg/bin/pg-backup full
```

**Schedule:** Daily at 1:00 AM (server time)

### Manual Backup

Trigger a manual full backup:

```bash
# SSH into VPS
ssh deploy@your.vps.ip

# Run manual backup
sudo -iu postgres /pg/bin/pg-backup full
```

## Recovery Operations

### List Available Backups

```bash
# SSH into VPS
ssh deploy@your.vps.ip

# List backups from S3 repository
sudo -iu postgres pgbackrest --stanza=pg-meta --repo=2 info

# List local backups
sudo -iu postgres pgbackrest --stanza=pg-meta --repo=1 info
```

### Full Database Restore

⚠️ **WARNING:** This will replace your current database!

```bash
# 1. Stop PostgreSQL
sudo systemctl stop patroni

# 2. Clear data directory
sudo -iu postgres rm -rf /pg/data/*

# 3. Restore from latest backup
sudo -iu postgres pgbackrest --stanza=pg-meta --repo=2 restore

# 4. Start PostgreSQL
sudo systemctl start patroni
```

### Point-in-Time Recovery (PITR)

Restore to a specific point in time:

```bash
# 1. Stop PostgreSQL
sudo systemctl stop patroni

# 2. Clear data directory
sudo -iu postgres rm -rf /pg/data/*

# 3. Restore to specific time
sudo -iu postgres pgbackrest \
  --stanza=pg-meta \
  --repo=2 \
  --type=time \
  --target="2025-11-20 10:30:00" \
  restore

# 4. Start PostgreSQL
sudo systemctl start patroni
```

**Time Formats:**
- `YYYY-MM-DD HH:MM:SS` - Specific time
- `YYYY-MM-DD` - Start of day
- `latest` - Most recent backup

## Backup Verification

### Check Backup Status

```bash
# SSH into VPS
ssh deploy@your.vps.ip

# Check last backup info
sudo -iu postgres pgbackrest --stanza=pg-meta info

# Verify backup integrity
sudo -iu postgres pgbackrest --stanza=pg-meta --repo=2 check
```

### Monitor Backup Size

```bash
# Check S3 repository size
sudo du -sh /pg/backup

# List backup files in S3
sudo -iu postgres pgbackrest --stanza=pg-meta --repo=2 info --output=json | jq
```

## Backup Metrics

pgBackRest exports metrics to Prometheus/Grafana:

- **Backup Status** - Success/failure of last backup
- **Backup Duration** - Time taken for backups
- **Backup Size** - Size of full and incremental backups
- **Repository Size** - Total storage used
- **Last Backup Time** - Timestamp of most recent backup

Access metrics at: `http://your-vps-ip:3000` (Grafana)

## Encryption

### AES-256-CBC Encryption

All backups to S3 are encrypted using AES-256-CBC:

```yaml
cipher_type: aes-256-cbc
cipher_pass: <PGBACKREST_CIPHER_PASS>
```

**Important:**
- ⚠️ **Save your cipher password securely!**
- Without the cipher password, backups cannot be restored
- Store in a password manager or secure vault
- Consider using different passwords for different environments

### Rotating Encryption Keys

To change the encryption password:

1. **Backup the current password**
2. **Update .env:**
   ```bash
   PGBACKREST_CIPHER_PASS=<new_password>
   ```
3. **Re-deploy configuration:**
   ```bash
   ./scripts/deploy config:sync
   ```
4. **Create a new full backup:**
   ```bash
   ssh deploy@your.vps.ip
   sudo -iu postgres /pg/bin/pg-backup full
   ```

⚠️ Old backups will still require the old password for restoration!

## Retention Policies

### Local Repository

```yaml
retention_full_type: count
retention_full: 2
```

Keeps the **2 most recent full backups** on local disk.

### S3 Repository

```yaml
retention_full_type: time
retention_full: 14
```

Keeps **14 days of full backups** in cloud storage.

### Customizing Retention

Update retention in `.env`:

```bash
# Keep 30 days in S3
PGBACKREST_RETENTION_FULL=30

# Keep 5 backups locally
PGBACKREST_LOCAL_RETENTION_FULL=5
```

Then re-deploy:

```bash
./scripts/deploy config:sync
```

## Storage Optimization

### Incremental Backups

pgBackRest uses **block-level incremental backups**:

```yaml
block: y  # Block incremental backup
```

Only changed blocks are backed up, significantly reducing:
- Backup time
- Storage usage
- Network bandwidth

### File Bundling

Small files are bundled together for efficiency:

```yaml
bundle: y
bundle_limit: 20MiB   # Bundle files smaller than 20MiB
bundle_size: 128MiB   # Target bundle size
```

**Benefits:**
- Fewer S3 API calls
- Reduced storage costs
- Faster backups and restores

## Troubleshooting

### Backup Fails

**Check logs:**

```bash
ssh deploy@your.vps.ip
sudo tail -f /pg/log/pgbackrest/pg-meta-backup.log
```

**Common issues:**

1. **S3 credentials invalid**
   - Verify `PGBACKREST_S3_ACCESS_KEY` and `PGBACKREST_S3_SECRET_KEY`
   - Test S3 connection: `./scripts/test-s3-connection`

2. **Insufficient disk space**
   - Check: `df -h /pg/backup`
   - Clean old backups: `sudo -iu postgres pgbackrest --stanza=pg-meta expire`

3. **Network issues**
   - Verify S3 endpoint reachable: `curl https://s3.us-east-005.backblazeb2.com`

### Restore Fails

**Check restore logs:**

```bash
sudo tail -f /pg/log/pgbackrest/pg-meta-restore.log
```

**Common issues:**

1. **Wrong cipher password**
   - Ensure `PGBACKREST_CIPHER_PASS` matches backup encryption
   - Check backup info: `sudo -iu postgres pgbackrest --stanza=pg-meta info`

2. **Backup not found**
   - List backups: `sudo -iu postgres pgbackrest --stanza=pg-meta --repo=2 info`
   - Verify bucket/region correct

## Best Practices

### ✅ DO

- **Test restores regularly** - Schedule quarterly restore tests
- **Monitor backup status** - Check Grafana dashboards daily
- **Keep local + cloud backups** - Use both repositories
- **Encrypt backups** - Always use `PGBACKREST_CIPHER_PASS`
- **Secure credentials** - Use strong passwords, store securely
- **Document recovery procedures** - Keep runbooks updated

### ❌ DON'T

- **Delete backups manually** - Use pgBackRest retention policies
- **Share cipher passwords** - Use separate passwords per environment
- **Ignore backup failures** - Set up alerts in Grafana
- **Skip testing restores** - Practice makes perfect
- **Use weak encryption** - Generate strong cipher passwords

## Cost Optimization

### Backblaze B2 Storage Costs

**Pricing (as of 2025):**
- Storage: $0.005/GB/month ($5/TB/month)
- Downloads: $0.01/GB (first 3x storage free)
- API calls: Free for most operations

**Example Cost for 100GB database:**

```
Daily full backup: 100GB
14 days retention: 100GB × 14 = 1.4TB
Monthly cost: 1.4TB × $5 = $7/month
```

**With incremental backups:**
- Day 1: 100GB (full)
- Day 2-7: ~10GB/day (incremental) = 60GB
- Total for 7 days: 160GB
- 14 days: ~320GB
- **Monthly cost: 320GB × $0.005 = $1.60/month**

### Reduce Costs

1. **Enable incremental backups** (enabled by default)
2. **Adjust retention** - Reduce from 14 to 7 days
3. **Use bundling** (enabled by default)
4. **Configure lifecycle policies** in Backblaze

## Security Checklist

- [ ] pgBackRest encryption enabled (`PGBACKREST_CIPHER_PASS` set)
- [ ] Strong cipher password (32+ characters)
- [ ] Cipher password stored securely (password manager)
- [ ] S3 credentials use Application Keys (not Master Key)
- [ ] S3 bucket is private
- [ ] Network access to S3 is encrypted (HTTPS)
- [ ] Backup verification runs regularly
- [ ] Restore procedures documented and tested
- [ ] Grafana backup alerts configured
- [ ] Team trained on recovery procedures

## Advanced Configuration

### Multiple S3 Repositories

Use both Backblaze B2 and AWS S3 for geographic redundancy:

```yaml
pgbackrest_repo:
  local:
    path: /pg/backup
    retention_full: 2
  backblaze:
    type: s3
    s3_endpoint: s3.us-east-005.backblazeb2.com
    s3_bucket: bits-postgres-backups
    retention_full: 14
  aws:
    type: s3
    s3_endpoint: s3.amazonaws.com
    s3_region: us-east-1
    s3_bucket: my-postgres-backups
    retention_full: 30
```

### Custom Backup Scripts

Create custom backup hooks in `/pg/bin/`:

```bash
#!/bin/bash
# /pg/bin/custom-backup-hook

# Pre-backup tasks
echo "Starting backup at $(date)"

# Run pgBackRest
/pg/bin/pg-backup full

# Post-backup tasks
echo "Backup completed at $(date)"

# Send notification
curl -X POST https://api.slack.com/webhooks/... \
  -d '{"text":"PostgreSQL backup completed"}'
```

## Support & Resources

- **Pigsty Documentation:** https://pigsty.io/docs/
- **pgBackRest Documentation:** https://pgbackrest.org/
- **Backblaze B2 Docs:** https://www.backblaze.com/docs/
- **Supabase Docs:** https://supabase.com/docs

## Summary

pgBackRest provides enterprise-grade backup and recovery for your Supabase PostgreSQL database with:

- ✅ Automated daily backups
- ✅ Point-in-Time Recovery
- ✅ Multi-repository redundancy
- ✅ AES-256 encryption
- ✅ S3-compatible storage (Backblaze B2, MinIO, AWS)
- ✅ Incremental backups for efficiency
- ✅ Monitoring and alerting

**Your data is safe, secure, and always recoverable.**
