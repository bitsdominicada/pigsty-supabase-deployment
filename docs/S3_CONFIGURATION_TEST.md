# S3 Configuration Testing Results

This document validates that the S3 configuration works correctly with both MinIO and Backblaze B2.

## Test Date
2025-11-19

## Test Methodology

1. Created test `.env` files for both providers
2. Generated base `pigsty.yml` 
3. Ran `yaml-update.py` with each configuration
4. Verified the output in `apps.supabase.conf`

---

## Test 1: Backblaze B2 Configuration

### Input (.env)
```bash
S3_BUCKET=supabase-storage
S3_ENDPOINT=https://s3.us-west-004.backblazeb2.com
S3_REGION=us-west-004
S3_ACCESS_KEY=0054f413fc50d980000000003
S3_SECRET_KEY=K005clOQr83kINWjCg9fWQ7GxaVsLY0
S3_FORCE_PATH_STYLE=false
S3_PROTOCOL=https
```

### Output (apps.supabase.conf)
```yaml
S3_ACCESS_KEY: 0054f413fc50d980000000003
S3_BUCKET: supabase-storage
S3_ENDPOINT: https://s3.us-west-004.backblazeb2.com
S3_FORCE_PATH_STYLE: false
S3_PROTOCOL: https
S3_REGION: us-west-004
S3_SECRET_KEY: K005clOQr83kINWjCg9fWQ7GxaVsLY0
```

### Validations
- ✅ S3_ENDPOINT es Backblaze (contains 'backblazeb2.com')
- ✅ S3_FORCE_PATH_STYLE es false (Backblaze requirement)
- ✅ MINIO_DOMAIN_IP NOT injected (only for MinIO)
- ✅ Credentials correctas (keyID matches)

**Result:** ✅ PASS - All validations passed

---

## Test 2: MinIO Configuration

### Input (.env)
```bash
S3_BUCKET=data
S3_ENDPOINT=https://sss.pigsty:9000
S3_REGION=stub
S3_ACCESS_KEY=s3user_data
S3_SECRET_KEY=S3User.Data
S3_FORCE_PATH_STYLE=true
S3_PROTOCOL=https
VPS_HOST=194.163.149.70
```

### Output (apps.supabase.conf)
```yaml
S3_ACCESS_KEY: s3user_data
S3_BUCKET: data
S3_ENDPOINT: https://sss.pigsty:9000
S3_FORCE_PATH_STYLE: true
S3_PROTOCOL: https
S3_REGION: stub
S3_SECRET_KEY: S3User.Data
MINIO_DOMAIN_IP: 194.163.149.70
```

### Validations
- ✅ S3_ENDPOINT es MinIO (contains 'sss.pigsty')
- ✅ S3_FORCE_PATH_STYLE es true (MinIO requirement)
- ✅ MINIO_DOMAIN_IP inyectado (auto-detected MinIO)
- ✅ MINIO_DOMAIN_IP correcto (matches VPS_HOST)

**Result:** ✅ PASS - All validations passed

---

## Configuration Comparison

| Variable | MinIO | Backblaze B2 | AWS S3 |
|----------|-------|--------------|---------|
| `S3_BUCKET` | `data` | User's bucket | User's bucket |
| `S3_ENDPOINT` | `https://sss.pigsty:9000` | `https://s3.REGION.backblazeb2.com` | `https://s3.REGION.amazonaws.com` |
| `S3_REGION` | `stub` | `us-west-004` (example) | `us-east-1` (example) |
| `S3_ACCESS_KEY` | `s3user_data` | Backblaze keyID | AWS access key |
| `S3_SECRET_KEY` | Generated by Pigsty | Backblaze applicationKey | AWS secret key |
| `S3_FORCE_PATH_STYLE` | `true` | `false` | `false` |
| `S3_PROTOCOL` | `https` | `https` | `https` |
| `MINIO_DOMAIN_IP` | Auto-injected (VPS_HOST) | Not injected | Not injected |

---

## Key Behaviors

### 1. Auto-Detection of MinIO
The script detects MinIO by checking if `S3_ENDPOINT` contains `"sss.pigsty"`:
```python
if env_vars.get("VPS_HOST") and "sss.pigsty" in env_vars.get("S3_ENDPOINT", ""):
    supa_conf["MINIO_DOMAIN_IP"] = env_vars["VPS_HOST"]
```

### 2. Passthrough Configuration
All `S3_*` variables are passed through directly from `.env` to `pigsty.yml`:
- No provider-specific logic
- No conditional behavior (except MINIO_DOMAIN_IP)
- Works with any S3-compatible provider

### 3. Boolean Conversion
`S3_FORCE_PATH_STYLE` is converted from string to boolean:
```python
supa_conf["S3_FORCE_PATH_STYLE"] = env_vars["S3_FORCE_PATH_STYLE"].lower() == "true"
```

---

## Test Credentials Used

### Backblaze B2 (Real Format)
```
keyID: 0054f413fc50d980000000003
keyName: bits-flare
applicationKey: K005clOQr83kINWjCg9fWQ7GxaVsLY0
Endpoint: s3.us-west-004.backblazeb2.com
```

### MinIO (Official Template)
```
Access Key: s3user_data
Secret Key: S3User.Data
Endpoint: sss.pigsty:9000
```

---

## Conclusion

✅ **Configuration system works correctly for both providers**

The simplified S3 configuration:
1. Follows the official Pigsty template exactly
2. Works with MinIO, Backblaze B2, and any S3-compatible provider
3. Auto-detects MinIO and injects `MINIO_DOMAIN_IP` only when needed
4. Passes through all `S3_*` variables without modification
5. Properly converts boolean values

**No changes needed** - the current implementation is production-ready.
