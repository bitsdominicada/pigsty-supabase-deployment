#!/usr/bin/env bash

# ============================================
# BACKBLAZE B2 DIAGNOSTIC SCRIPT
# ============================================
# Helps diagnose S3 API connection issues

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/utils.sh"

print_banner
log_step "Backblaze B2 Diagnostic Tool"
echo ""

# Load .env
load_env

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}  Current Configuration${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo "Bucket: ${S3_BUCKET}"
echo "Endpoint: ${S3_ENDPOINT}"
echo "Region: ${S3_REGION}"
echo "Access Key: ${S3_ACCESS_KEY:0:20}..."
echo "Secret Key: ${S3_SECRET_KEY:0:10}...${S3_SECRET_KEY: -5}"
echo "Force Path Style: ${S3_FORCE_PATH_STYLE:-false}"
echo ""

# Test 1: Try to list buckets with different endpoints
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}  Test 1: Trying Different Regions${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

REGIONS=("us-west-000" "us-west-001" "us-west-002" "us-west-003" "us-west-004" "us-east-005")

export AWS_ACCESS_KEY_ID="${S3_ACCESS_KEY}"
export AWS_SECRET_ACCESS_KEY="${S3_SECRET_KEY}"

for region in "${REGIONS[@]}"; do
    endpoint="https://s3.${region}.backblazeb2.com"
    echo -n "Testing ${region}... "

    if aws s3 ls --endpoint-url "${endpoint}" --region "${region}" 2>&1 | grep -q "bits-supabase-storage"; then
        echo -e "${GREEN}✓ FOUND!${NC}"
        echo ""
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${GREEN}  SUCCESS! Correct configuration:${NC}"
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo ""
        echo "S3_ENDPOINT=https://s3.${region}.backblazeb2.com"
        echo "S3_REGION=${region}"
        echo ""
        echo "Update your .env with these values!"
        exit 0
    else
        echo -e "${YELLOW}not found${NC}"
    fi
done

echo ""
echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${RED}  No matching region found${NC}"
echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Test 2: Try raw API call
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}  Test 2: Verbose Error Output${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

echo "Attempting to list buckets with full error details:"
echo ""
aws s3 ls --endpoint-url "${S3_ENDPOINT}" --region "${S3_REGION}" --debug 2>&1 | tail -50

echo ""
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${YELLOW}  Diagnostic Complete${NC}"
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo "Please check:"
echo "  1. Verify the bucket name in Backblaze dashboard"
echo "  2. Check the endpoint shown in Backblaze bucket details"
echo "  3. Ensure the Application Key has access to this bucket"
echo "  4. Try waiting 2-3 minutes for key propagation"
