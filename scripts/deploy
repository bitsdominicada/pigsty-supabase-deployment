#!/usr/bin/env bash

# ============================================
# PIGSTY SUPABASE - DEPLOYMENT ORCHESTRATOR
# ============================================
# Single entry point for all operations
#
# Usage:
#   ./scripts/deploy          - Full deployment
#   ./scripts/deploy prepare  - Prepare VPS only
#   ./scripts/deploy config   - Configure only
#   ./scripts/deploy install  - Install stack only
#   ./scripts/deploy verify   - Health check
#   ./scripts/deploy all      - Run all steps
# ============================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Change to project root
cd "${PROJECT_ROOT}"

source "${SCRIPT_DIR}/utils.sh"

# Help message
show_help() {
    print_banner
    cat << HELP
${GREEN}Usage:${NC}
  ./scripts/deploy [command]

${GREEN}Deployment Commands:${NC}
  ${BLUE}all${NC}       - Run full deployment (prepare + config + install)
  ${BLUE}prepare${NC}   - Prepare VPS (user, SSH, dependencies)
  ${BLUE}config${NC}    - Configure Pigsty from official template
  ${BLUE}install${NC}   - Install stack (Pigsty + Docker + Supabase)
  ${BLUE}verify${NC}    - Run health check

${GREEN}Configuration Management:${NC}
  ${BLUE}config:pull${NC}   - Download config from VPS
  ${BLUE}config:sync${NC}   - Upload local config to VPS
  ${BLUE}config:diff${NC}   - Show differences (local vs VPS)

${GREEN}Apply Changes:${NC}
  ${BLUE}apply${NC}         - Apply all configuration changes
  ${BLUE}apply:infra${NC}   - Apply INFRA module changes only
  ${BLUE}apply:pgsql${NC}   - Apply PostgreSQL module changes only
  ${BLUE}apply:node${NC}    - Apply NODE module changes only
  ${BLUE}apply:app${NC}     - Apply APP (Supabase) module changes only

${GREEN}SSL Management:${NC}
  ${BLUE}ssl:setup${NC}     - Setup HTTPS with Let's Encrypt
  ${BLUE}ssl:status${NC}    - Check certificate status
  ${BLUE}ssl:renew${NC}     - Renew SSL certificate

${GREEN}Storage Management:${NC}
  ${BLUE}storage:b2${NC}    - Configure Backblaze B2 for Supabase Storage
  ${BLUE}storage:test${NC}  - Test storage upload/download

${GREEN}Updates:${NC}
  ${BLUE}update:supabase${NC} - Update Supabase to latest official versions

${GREEN}Other:${NC}
  ${BLUE}help${NC}          - Show this help message

${GREEN}Examples:${NC}
  # Full deployment (recommended for first time)
  ./scripts/deploy all

  # Step by step
  ./scripts/deploy prepare
  ./scripts/deploy config
  ./scripts/deploy install
  ./scripts/deploy verify

${GREEN}Pre-requisites:${NC}
  1. Copy .env.example to .env
  2. Configure VPS credentials in .env
  3. Set strong passwords in .env

${GREEN}Documentation:${NC}
  See README.md for detailed instructions
HELP
}

# Command dispatcher
case "${1:-all}" in
    all)
        print_banner
        log_info "Starting full deployment"

        source "${SCRIPT_DIR}/modules/01-prepare.sh"
        prepare_vps

        source "${SCRIPT_DIR}/modules/02-configure.sh"
        configure_pigsty

        source "${SCRIPT_DIR}/modules/03-install.sh"
        install_stack

        # Post-deployment fixes for Supabase
        log_info "Running post-deployment fixes..."
        source "${SCRIPT_DIR}/modules/06-post-supabase.sh"
        main

        # Check if Backblaze B2 is configured
        load_env
        if [ -n "${S3_BUCKET:-}" ] && [[ "${S3_ENDPOINT:-}" == *"backblazeb2.com"* ]]; then
            log_info "Backblaze B2 detected, configuring storage..."
            source "${SCRIPT_DIR}/modules/09-configure-b2-storage.sh"
            configure_b2_storage
        fi

        # Check if SSL is configured in .env
        if [ "${USE_LETSENCRYPT:-false}" = "true" ] && [ -n "${SUPABASE_DOMAIN:-}" ]; then
            log_info "SSL enabled in .env, setting up HTTPS..."
            "${SCRIPT_DIR}/modules/08-ssl-setup.sh" setup
        else
            log_warning "SSL not configured in .env (USE_LETSENCRYPT=false or SUPABASE_DOMAIN empty)"
            log_info "To enable HTTPS later, run: ./scripts/deploy ssl:setup"
        fi

        echo ""
        log_success "Deployment completed successfully!"

        # Show final status
        load_env
        echo ""
        log_step "Deployment Summary"
        echo ""
        echo -e "${GREEN}✓ PostgreSQL 17${NC} running on ${BLUE}${VPS_HOST}:5432${NC}"
        echo -e "${GREEN}✓ pgBouncer${NC} connection pooler on ${BLUE}${VPS_HOST}:6432${NC}"
        echo -e "${GREEN}✓ HAProxy${NC} load balancer on ${BLUE}${VPS_HOST}:5436${NC}"
        echo -e "${GREEN}✓ Grafana${NC} dashboard at ${BLUE}http://${VPS_HOST}:3000${NC}"
        echo -e "${GREEN}✓ Supabase Studio${NC} at ${BLUE}http://${VPS_HOST}:8000${NC}"

        if [ "${USE_LETSENCRYPT:-false}" = "true" ] && [ -n "${SUPABASE_DOMAIN:-}" ]; then
            echo ""
            echo -e "${GREEN}✓ HTTPS Enabled:${NC} ${BLUE}https://${SUPABASE_DOMAIN}${NC}"
        fi

        echo ""
        ;;

    prepare)
        print_banner
        source "${SCRIPT_DIR}/modules/01-prepare.sh"
        prepare_vps
        ;;

    config|configure)
        print_banner
        source "${SCRIPT_DIR}/modules/02-configure.sh"
        configure_pigsty
        ;;

    install)
        print_banner
        source "${SCRIPT_DIR}/modules/03-install.sh"
        install_stack
        ;;

    verify|check|health)
        print_banner
        source "${SCRIPT_DIR}/modules/04-verify.sh"
        verify_deployment
        ;;

    # Configuration management
    config:pull)
        print_banner
        source "${SCRIPT_DIR}/modules/05-config-sync.sh"
        ;;

    config:sync|config:push)
        print_banner
        "${SCRIPT_DIR}/modules/05-config-sync.sh" sync
        ;;

    config:diff)
        print_banner
        "${SCRIPT_DIR}/modules/05-config-sync.sh" diff
        ;;

    # Apply changes
    apply)
        print_banner
        "${SCRIPT_DIR}/modules/06-config-apply.sh" all
        ;;

    apply:infra)
        print_banner
        "${SCRIPT_DIR}/modules/06-config-apply.sh" infra "${2:-}"
        ;;

    apply:pgsql)
        print_banner
        "${SCRIPT_DIR}/modules/06-config-apply.sh" pgsql "${2:-}"
        ;;

    apply:node)
        print_banner
        "${SCRIPT_DIR}/modules/06-config-apply.sh" node "${2:-}"
        ;;

    apply:app)
        print_banner
        "${SCRIPT_DIR}/modules/06-config-apply.sh" app "${2:-}"
        ;;

    # SSL Management
    ssl:setup)
        print_banner
        "${SCRIPT_DIR}/modules/08-ssl-setup.sh" setup
        ;;

    ssl:status)
        print_banner
        "${SCRIPT_DIR}/modules/08-ssl-setup.sh" status
        ;;

    ssl:renew)
        print_banner
        "${SCRIPT_DIR}/modules/08-ssl-setup.sh" renew
        ;;

    # Storage Management
    storage:b2|storage:backblaze)
        print_banner
        source "${SCRIPT_DIR}/modules/09-configure-b2-storage.sh"
        configure_b2_storage
        ;;

    storage:test)
        print_banner
        log_step "Testing Storage Upload/Download"
        if [ ! -f "${PROJECT_ROOT}/test-storage-simple.sh" ]; then
            log_error "Test script not found: test-storage-simple.sh"
            exit 1
        fi
        "${PROJECT_ROOT}/test-storage-simple.sh"
        ;;

    # Update Supabase versions
    update:supabase|update:versions)
        print_banner
        if [ ! -f "${PROJECT_ROOT}/update-supabase-versions.sh" ]; then
            log_error "Update script not found: update-supabase-versions.sh"
            exit 1
        fi
        "${PROJECT_ROOT}/update-supabase-versions.sh"
        ;;

    help|--help|-h)
        show_help
        ;;

    *)
        echo -e "${RED}Error: Unknown command '$1'${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
