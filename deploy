#!/usr/bin/env bash
#==============================================================================#
# PIGSTY SUPABASE - SIMPLIFIED DEPLOYMENT
#==============================================================================#
# Single-command deployment using official Pigsty flow
#
# Usage:
#   ./deploy              # Interactive setup + full deploy
#   ./deploy setup        # Only generate configuration
#   ./deploy install      # Only run Pigsty installation
#   ./deploy supabase     # Only launch Supabase containers
#   ./deploy harden       # Only apply security hardening
#   ./deploy status       # Check deployment status
#
# Requirements:
#   - SSH key access to VPS (ubuntu user)
#   - Fresh Ubuntu 22.04/24.04 VPS
#
# Flow:
#   1. Setup   → Generate .env + pigsty.yml
#   2. Install → Download Pigsty + deploy.yml + docker.yml
#   3. Launch  → app.yml (Supabase containers)
#   4. Harden  → SSL + Firewall + Health endpoint
#==============================================================================#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PIGSTY_VERSION="v4.0.0-c1"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

#==============================================================================#
# UTILITY FUNCTIONS
#==============================================================================#

log_info()    { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error()   { echo -e "${RED}[ERROR]${NC} $1"; }
log_step()    { echo -e "\n${BOLD}━━━ $1 ━━━${NC}\n"; }

load_env() {
    if [[ ! -f "$SCRIPT_DIR/.env" ]]; then
        log_error "No .env file found. Run: ./deploy setup"
        exit 1
    fi
    set -a
    source "$SCRIPT_DIR/.env"
    set +a
}

ssh_cmd() {
    ssh -i "${SSH_KEY:-$HOME/.ssh/id_ed25519}" \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o LogLevel=ERROR \
        "${SSH_USER:-ubuntu}@${VPS_HOST}" "$@"
}

scp_file() {
    scp -i "${SSH_KEY:-$HOME/.ssh/id_ed25519}" \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o LogLevel=ERROR \
        "$1" "${SSH_USER:-ubuntu}@${VPS_HOST}:$2"
}

#==============================================================================#
# PHASE 1: SETUP (Generate configuration)
#==============================================================================#

do_setup() {
    log_step "SETUP: Generate Configuration"

    source "$SCRIPT_DIR/scripts/setup.sh"
    run_setup

    log_success "Configuration saved to .env"
    log_info "Review and edit .env if needed, then run: ./deploy install"
}

#==============================================================================#
# PHASE 2: INSTALL (Pigsty + PostgreSQL + Docker)
#==============================================================================#

do_install() {
    load_env
    log_step "INSTALL: Pigsty ${PIGSTY_VERSION} + PostgreSQL 18"

    log_info "Target: ${VPS_HOST}"
    log_info "Domain: ${SUPABASE_DOMAIN}"
    echo ""

    # Step 1: Test SSH connection
    log_info "Testing SSH connection..."
    if ! ssh_cmd "echo 'connected'" &>/dev/null; then
        log_error "Cannot connect to ${VPS_HOST}"
        log_info "Check SSH_USER and SSH_KEY in .env"
        exit 1
    fi
    log_success "SSH connection OK"

    # Step 2: Download Pigsty
    log_info "Downloading Pigsty ${PIGSTY_VERSION}..."
    ssh_cmd "curl -fsSL https://repo.pigsty.io/get | bash -s ${PIGSTY_VERSION}"
    log_success "Pigsty downloaded"

    # Step 3: Generate pigsty.yml from template
    log_info "Generating pigsty.yml..."
    source "$SCRIPT_DIR/scripts/generate-config.sh"
    generate_pigsty_yml > /tmp/pigsty.yml
    scp_file /tmp/pigsty.yml "~/pigsty/pigsty.yml"
    rm /tmp/pigsty.yml
    log_success "Configuration uploaded"

    # Step 4: Run deploy.yml (installs everything)
    log_info "Running deploy.yml (this takes 15-20 minutes)..."
    log_info "Installing: PostgreSQL 18, Patroni, etcd, VictoriaMetrics, Grafana..."
    ssh_cmd "cd ~/pigsty && ./deploy.yml"
    log_success "Pigsty installed"

    # Step 5: Run docker.yml
    log_info "Installing Docker..."
    ssh_cmd "cd ~/pigsty && ./docker.yml"
    log_success "Docker installed"

    log_success "Installation complete!"
    log_info "Next: ./deploy supabase"
}

#==============================================================================#
# PHASE 3: SUPABASE (Launch containers)
#==============================================================================#

do_supabase() {
    load_env
    log_step "SUPABASE: Launch Containers"

    # Run app.yml to launch Supabase
    log_info "Launching Supabase containers..."
    ssh_cmd "cd ~/pigsty && ./app.yml -e app=supabase"

    # Wait for containers to start
    log_info "Waiting for containers to start..."
    sleep 15

    # Check container status
    local running=$(ssh_cmd "docker ps --format '{{.Names}}' | grep -c supabase" || echo "0")

    if [[ "$running" -ge 10 ]]; then
        log_success "All Supabase containers running ($running/11)"
    else
        log_warn "Only $running/11 containers running"
        log_info "Check with: ./deploy status"
    fi

    log_success "Supabase launched!"
    log_info "Next: ./deploy harden"
}

#==============================================================================#
# PHASE 4: HARDEN (Security + SSL + Health)
#==============================================================================#

do_harden() {
    load_env
    log_step "HARDEN: Security + SSL + Health"

    # UFW Firewall
    log_info "Configuring firewall..."
    ssh_cmd "sudo ufw --force reset && \
        sudo ufw default deny incoming && \
        sudo ufw default allow outgoing && \
        sudo ufw allow 22/tcp && \
        sudo ufw allow 80/tcp && \
        sudo ufw allow 443/tcp && \
        sudo ufw allow 3000/tcp && \
        sudo ufw allow 5432/tcp && \
        sudo ufw allow 8000/tcp && \
        sudo ufw --force enable"
    log_success "Firewall configured"

    # Fail2ban
    log_info "Configuring fail2ban..."
    ssh_cmd "sudo apt-get install -y fail2ban >/dev/null 2>&1 && \
        sudo systemctl enable fail2ban && \
        sudo systemctl start fail2ban"
    log_success "Fail2ban configured"

    # SSL Certificate (if domain configured)
    if [[ "${USE_LETSENCRYPT:-false}" == "true" ]] && [[ -n "${SUPABASE_DOMAIN:-}" ]]; then
        log_info "Requesting SSL certificate for ${SUPABASE_DOMAIN}..."
        ssh_cmd "sudo certbot certonly --nginx --non-interactive --agree-tos \
            -m ${LETSENCRYPT_EMAIL} \
            -d ${SUPABASE_DOMAIN} \
            -d api.${SUPABASE_DOMAIN} \
            -d studio.${SUPABASE_DOMAIN}" || log_warn "SSL request failed - check DNS"
    fi

    # Health endpoint
    log_info "Setting up health endpoint..."
    source "$SCRIPT_DIR/scripts/health.sh"
    setup_health_endpoint
    log_success "Health endpoint at http://${VPS_HOST}:8080/health"

    log_success "Hardening complete!"
}

#==============================================================================#
# STATUS CHECK
#==============================================================================#

do_status() {
    load_env
    log_step "STATUS: Deployment Check"

    echo -e "${BOLD}VPS:${NC} ${VPS_HOST}"
    echo -e "${BOLD}Domain:${NC} ${SUPABASE_DOMAIN:-not set}"
    echo ""

    # PostgreSQL
    echo -n "PostgreSQL: "
    if ssh_cmd "sudo -u postgres psql -c 'SELECT 1'" &>/dev/null; then
        echo -e "${GREEN}Running${NC}"
    else
        echo -e "${RED}Down${NC}"
    fi

    # Patroni
    echo -n "Patroni:    "
    if ssh_cmd "systemctl is-active patroni" &>/dev/null; then
        echo -e "${GREEN}Running${NC}"
    else
        echo -e "${RED}Down${NC}"
    fi

    # Docker
    echo -n "Docker:     "
    if ssh_cmd "systemctl is-active docker" &>/dev/null; then
        echo -e "${GREEN}Running${NC}"
    else
        echo -e "${RED}Down${NC}"
    fi

    # Supabase containers
    echo ""
    echo -e "${BOLD}Supabase Containers:${NC}"
    ssh_cmd "docker ps --format 'table {{.Names}}\t{{.Status}}' 2>/dev/null | grep -E 'supabase|NAMES'" || echo "No containers"

    # URLs
    echo ""
    echo -e "${BOLD}URLs:${NC}"
    local proto="http"
    [[ "${USE_LETSENCRYPT:-false}" == "true" ]] && proto="https"
    echo "  App:     ${proto}://${SUPABASE_DOMAIN:-$VPS_HOST}"
    echo "  API:     ${proto}://api.${SUPABASE_DOMAIN:-$VPS_HOST}:8000"
    echo "  Studio:  ${proto}://studio.${SUPABASE_DOMAIN:-$VPS_HOST}:3001"
    echo "  Grafana: http://${VPS_HOST}:3000"
    echo "  Health:  http://${VPS_HOST}:8080/health"
}

#==============================================================================#
# FULL DEPLOY (All phases)
#==============================================================================#

do_all() {
    # Check if .env exists
    if [[ ! -f "$SCRIPT_DIR/.env" ]]; then
        do_setup
    fi

    do_install
    do_supabase
    do_harden
    do_status

    echo ""
    log_success "Deployment complete!"
}

#==============================================================================#
# HELP
#==============================================================================#

show_help() {
    cat << 'EOF'

╔═══════════════════════════════════════════════════════════════╗
║  PIGSTY SUPABASE - Simplified Deployment                      ║
║  PostgreSQL 18 + Supabase + Monitoring                        ║
╚═══════════════════════════════════════════════════════════════╝

Usage: ./deploy [command]

Commands:
  (none)      Full deployment (setup + install + supabase + harden)
  setup       Generate .env and pigsty.yml configuration
  install     Install Pigsty (PostgreSQL, Docker, Monitoring)
  supabase    Launch Supabase containers
  harden      Apply security (SSL, Firewall, Health endpoint)
  status      Check deployment status

Examples:
  ./deploy                 # Full deployment with interactive setup
  ./deploy status          # Check what's running
  ./deploy supabase        # Re-launch Supabase containers

Requirements:
  - SSH key access to Ubuntu 22.04/24.04 VPS
  - 4GB+ RAM, 2+ CPU, 40GB+ disk

EOF
}

#==============================================================================#
# MAIN
#==============================================================================#

main() {
    case "${1:-}" in
        setup)    do_setup ;;
        install)  do_install ;;
        supabase) do_supabase ;;
        harden)   do_harden ;;
        status)   do_status ;;
        help|-h|--help) show_help ;;
        "")       do_all ;;
        *)
            log_error "Unknown command: $1"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
